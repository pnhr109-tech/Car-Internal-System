# OAuth 2.0方式によるGmail API設定手順

## 概要

OAuth 2.0方式は、**ドメインワイド委任（DWD）不要**の簡単なセットアップ方法です。

### メリット
- Google Workspace管理者権限が不要
- 設定が簡単（Google Cloud Consoleだけで完結）
- 個人のGmailアカウントでも使用可能

### デメリット
- 初回実行時にブラウザで認証が必要（その後は自動）
- 認証したユーザーのメールボックスのみアクセス可能

---

## 1. Google Cloud Consoleでプロジェクトを作成

### 1-1. プロジェクト作成
1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 画面上部の「プロジェクトを選択」→「新しいプロジェクト」
3. プロジェクト名を入力（例: `navikuru-gmail-fetch`）
4. 「作成」をクリック

### 1-2. Gmail APIを有効化
1. 左側メニュー「APIとサービス」→「ライブラリ」
2. 検索ボックスに「Gmail API」と入力
3. 「Gmail API」をクリック
4. 「有効にする」をクリック

---

## 2. OAuth 2.0クライアントIDを作成

### 2-1. OAuth同意画面を設定
1. 左側メニュー「APIとサービス」→「OAuth 同意画面」

2. **「開始」ボタンをクリック**
   - 「Google Auth Platformはまだ構成されていません」と表示されている場合は、青い「開始」ボタンをクリック

3. **「プロジェクト構成」画面で必須項目を入力**
   - User Typeの選択画面が表示されず、直接この画面になる場合があります（User Typeは自動的に「外部」に設定されます）
   
   **アプリ情報:**
   - **アプリ名**: `ナビクル新着メール読込` と入力
   - **ユーザーサポートメール**: ドロップダウンから自分のメールアドレスを選択

4. 画面を下にスクロールして、**デベロッパーの連絡先情報**にもメールアドレスを入力

5. 画面下部の**「作成」ボタン**をクリック
   - ⚠️「保存して次へ」ではなく「作成」ボタンです

### 2-2. OAuth 2.0クライアントIDを作成

「作成」ボタンをクリックした後、次の手順に進みます：

1. 左側メニュー「APIとサービス」→「認証情報」に移動
2. 「認証情報を作成」→「OAuth クライアント ID」
3. **アプリケーションの種類**: `デスクトップ アプリ`
4. **名前**: `ナビクル Gmail Fetch Client`
5. 「作成」をクリック
6. **credentials.jsonをダウンロード**
   - ダウンロードボタン（↓）をクリック
   - `credentials.json`という名前で保存

---

## 3. credentials.jsonを配置

1. ダウンロードした`credentials.json`を**プロジェクトのルートフォルダ**に配置
   ```
   Car-Internal-System/
   ├── credentials.json  ← ここに配置
   ├── .env
   ├── manage.py
   └── ...
   ```

2. ファイル名が`credentials.json`であることを確認
   - もし異なる名前（例: `client_secret_xxx.json`）なら、`credentials.json`にリネーム

---

## 4. 認証テストを実行

### 4-1. 必要なパッケージをインストール
```powershell
.\venv\Scripts\Activate.ps1
pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
```

### 4-2. 認証テストスクリプトを実行
```powershell
python test_oauth.py
```

### 4-3. ブラウザで認証
1. ブラウザが自動で開きます
2. Googleアカウントでログイン（メール取得に使用するアカウント）
3. 「アプリがGoogleアカウントへのアクセスをリクエストしています」画面で「許可」をクリック
4. 「認証が完了しました」と表示されたら、ブラウザを閉じる
5. ターミナルに戻ると、接続テストが自動で続行されます

### 4-4. 成功時の出力例
```
====================================================================
✅ 接続成功！
====================================================================
メールアドレス: receiver@example.com
総メール数: 1,234
====================================================================

📬 最新メール1件を取得中...

最新メール:
  From: example@example.com
  Subject: テストメール
  Date: Mon, 10 Feb 2026 10:00:00 +0900

====================================================================
✅ OAuth 2.0認証テスト完了
====================================================================
```

### 4-5. token.jsonの生成
- 認証成功後、`token.json`が自動生成されます
- このファイルに認証情報が保存されるため、**次回以降はブラウザ認証不要**
- `token.json`は**gitignoreに追加**してください（機密情報）

---

## 5. メール取得を実行

### 5-1. テスト実行（最新10件）
```powershell
python manage.py fetch_gmail --days 1 --max 10
```

### 5-2. 本番実行（最新100件）
```powershell
python manage.py fetch_gmail --days 1 --max 100
```

### 5-3. 成功時の出力例
```
============================================================
Gmail メール取得開始
============================================================

検索条件: subject:申込み依頼がございました from:sender@example.com to:receiver@example.com newer_than:1d
最大取得件数: 10
✓ Gmail API接続成功

5件のメールが見つかりました

  [1/5] ✓ 新規保存 & 申込情報抽出 【かんたん車査定ガイド】申込み依頼がございました。
  [2/5] - スキップ（既存） 【かんたん車査定ガイド】申込み依頼がございました。
  ...

============================================================
✅ 完了
  新規保存: 3件
  申込情報抽出: 3件
  スキップ: 2件
============================================================
```

---

## 6. 自動実行の設定（タスクスケジューラ）

### 6-1. PowerShellスクリプトを作成
`run_fetch_gmail.ps1`を作成:
```powershell
Set-Location "C:\Users\pnhr1\OneDrive\ドキュメント\01_gigi_work\01_社内システム\01_アプリ開発\Car-Internal-System"
.\venv\Scripts\Activate.ps1
python manage.py fetch_gmail --days 1 --max 100
```

### 6-2. Windowsタスクスケジューラで設定
1. タスクスケジューラを起動
2. 「タスクの作成」
3. **トリガー**: 1分ごとに繰り返す
4. **操作**: `powershell.exe -ExecutionPolicy Bypass -File "C:\...\run_fetch_gmail.ps1"`

---

## トラブルシューティング

### ❌ credentials.jsonが見つかりません
**原因**: credentials.jsonがプロジェクトルートにない  
**対処**: ファイルを正しい場所に配置

### ❌ 認証失敗 (invalid_grant)
**原因**: token.jsonが古い、または無効  
**対処**: `token.json`を削除して再度`python test_oauth.py`を実行

### ❌ アクセスが拒否されました
**原因**: テストユーザーに追加されていない（外部アプリの場合）  
**対処**: OAuth同意画面でテストユーザーを追加

### ❌ Browser authentication failed
**原因**: ブラウザが自動で開かない  
**対処**: 手動でURLをコピーしてブラウザで開く

---

## DWD（ドメインワイド委任）への切り替え

後でDWD方式に切り替えたい場合は、以下の手順で対応できます：

1. サービスアカウントを作成
2. ドメインワイド委任を有効化
3. Google Workspaceで権限を設定
4. `fetch_gmail.py`の`_build_gmail_service()`メソッドを修正
5. `GMAIL_API_SETUP.md`の手順に従う

**コードの変更箇所**:
- インポート文を`google.oauth2.service_account`に変更
- `_build_gmail_service()`を元のDWD方式に戻す

---

## まとめ

✅ OAuth 2.0方式はセットアップが簡単  
✅ 初回のみブラウザ認証、以降は自動  
✅ 後でDWD方式に切り替え可能  
✅ 個人Gmail、Google Workspace両方で使用可能  

**次のステップ**: `python test_oauth.py` で認証テストを実行
