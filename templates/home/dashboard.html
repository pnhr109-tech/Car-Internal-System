{% extends 'base/internal_base.html' %}

{% block title %}トップページ - gigicompany{% endblock %}
{% block body_class %}bg-light{% endblock %}

{% block extra_head %}
    <style>
        .dashboard-assessment-table {
            width: 100%;
            table-layout: fixed;
        }

        .dashboard-assessment-table th,
        .dashboard-assessment-table td {
            white-space: normal;
            word-break: break-word;
            overflow-wrap: anywhere;
            font-size: 0.68rem;
            line-height: 1.14;
            padding: 0.26rem 0.18rem;
            vertical-align: middle;
        }

        .dashboard-assessment-table th {
            font-weight: 600;
            font-size: 0.64rem;
            line-height: 1.1;
        }

        .dashboard-assessment-table .btn-sm {
            --bs-btn-padding-y: 0.15rem;
            --bs-btn-padding-x: 0.35rem;
            --bs-btn-font-size: 0.68rem;
        }

        .dashboard-assessment-table .col-application-number { width: 8.5%; }
        .dashboard-assessment-table .col-application-datetime { width: 7.8%; }
        .dashboard-assessment-table .col-owner { width: 6%; }
        .dashboard-assessment-table .col-status { width: 6%; }
        .dashboard-assessment-table .col-customer { width: 6.5%; }
        .dashboard-assessment-table .col-phone { width: 7%; }
        .dashboard-assessment-table .col-sale-timing { width: 6%; }
        .dashboard-assessment-table .col-maker { width: 5.5%; }
        .dashboard-assessment-table .col-model { width: 5.5%; }
        .dashboard-assessment-table .col-year { width: 4.5%; }
        .dashboard-assessment-table .col-mileage { width: 5%; }
        .dashboard-assessment-table .col-address { width: 7.4%; }
        .dashboard-assessment-table .col-action { width: 4.5%; }

        .dashboard-assessment-table .application-number-cell,
        .dashboard-assessment-table .application-datetime-cell {
            white-space: nowrap;
            overflow-wrap: normal;
            word-break: normal;
        }

        .dashboard-assessment-table .application-datetime-cell {
            white-space: normal;
            line-height: 1.1;
        }

        .dashboard-assessment-table .application-datetime-cell .date-part,
        .dashboard-assessment-table .application-datetime-cell .time-part {
            display: block;
            white-space: nowrap;
        }

        .dashboard-assessment-table .action-cell {
            text-align: center;
        }

        .dashboard-assessment-table .owner-name-cell {
            white-space: normal;
            line-height: 1.12;
        }

        .dashboard-table-wrapper {
            overflow-x: hidden !important;
            overflow-y: auto;
        }

        .workspace-panel {
            overflow-y: auto;
            padding: 0.75rem;
            background-color: var(--bs-secondary-bg);
        }

        .workspace-panel.chat {
            height: 300px;
        }

        .workspace-panel.calendar {
            height: 600px;
        }

        .workspace-item {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.55rem 0.65rem;
            margin-bottom: 0.55rem;
            background-color: #fff;
        }

        .workspace-item.chat-item {
            border-left: 0.3rem solid var(--bs-primary);
        }

        .workspace-item.calendar-item {
            border-left: 0.3rem solid var(--bs-success);
        }

        .workspace-item .workspace-text {
            margin-top: 0.1rem;
            margin-bottom: 0.15rem;
            color: var(--bs-body-color);
        }

        .workspace-item:last-child {
            margin-bottom: 0;
        }

        .workspace-item .meta {
            color: #6c757d;
            font-size: 0.78rem;
        }

        .workspace-empty {
            color: #6c757d;
            font-size: 0.9rem;
            text-align: center;
            padding: 1rem 0.5rem;
        }

        .google-wordmark {
            font-weight: 700;
            letter-spacing: 0.02em;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid py-4">
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center bg-primary-subtle border-primary-subtle">
                        <span>
                            <span class="google-wordmark"><span class="text-primary">G</span><span class="text-danger">o</span><span class="text-warning">o</span><span class="text-primary">g</span><span class="text-success">l</span><span class="text-danger">e</span></span>
                            チャット（最新）
                        </span>
                        <a href="https://chat.google.com/" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">Google Chatを開く</a>
                    </div>
                    <div class="card-body workspace-panel chat" id="chatPanel">
                        <div class="workspace-empty">読み込み中...</div>
                    </div>
                </div>
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center bg-success-subtle border-success-subtle">
                        <span>
                            <span class="google-wordmark"><span class="text-primary">G</span><span class="text-danger">o</span><span class="text-warning">o</span><span class="text-primary">g</span><span class="text-success">l</span><span class="text-danger">e</span></span>
                            カレンダー（予定）
                        </span>
                        <a href="https://calendar.google.com/" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-success">Google Calendarを開く</a>
                    </div>
                    <div class="card-body workspace-panel calendar" id="calendarPanel">
                        <div class="workspace-empty">読み込み中...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>査定申込一覧（最新100件）</span>
                        <a href="/sateiinfo/" class="btn btn-sm btn-outline-primary">一覧へ</a>
                    </div>
                    <div class="card-body p-0 d-flex flex-column" style="height: 550px;">
                        <div class="table-responsive dashboard-table-wrapper flex-grow-1">
                            <table class="table table-striped table-hover table-sm mb-0 dashboard-assessment-table">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th class="col-application-number">お申込番号</th>
                                        <th class="col-application-datetime">お申込日時</th>
                                        <th class="col-owner">担当営業</th>
                                        <th class="col-status">対応ステータス</th>
                                        <th class="col-customer">お名前</th>
                                        <th class="col-phone">電話番号</th>
                                        <th class="col-sale-timing">希望売却時期</th>
                                        <th class="col-maker">メーカー</th>
                                        <th class="col-model">車種</th>
                                        <th class="col-year">年式</th>
                                        <th class="col-mileage">走行距離</th>
                                        <th class="col-address">住所</th>
                                        <th class="col-action">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in latest_assessments %}
                                    <tr>
                                        <td class="application-number-cell"><a href="#" class="text-decoration-none fw-semibold" onclick="event.preventDefault(); openTopDetailModal({{ item.id }})">{{ item.application_number }}</a></td>
                                        <td class="application-datetime-cell">
                                            <span class="date-part">{{ item.application_datetime|date:'Y-m-d' }}</span>
                                            <span class="time-part">{{ item.application_datetime|date:'H:i' }}</span>
                                        </td>
                                        <td class="owner-name-cell">{{ item.sales_owner_name|default:'-' }}</td>
                                        <td>{{ item.follow_status }}</td>
                                        <td>{{ item.customer_name }}</td>
                                        <td>
                                            {% if item.phone_number %}
                                            <a href="tel:{{ item.phone_number }}" class="text-decoration-none">{{ item.phone_number }}</a>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>{{ item.desired_sale_timing }}</td>
                                        <td>{{ item.maker }}</td>
                                        <td>{{ item.car_model }}</td>
                                        <td>{{ item.year }}</td>
                                        <td>{{ item.mileage }}</td>
                                        <td>{{ item.address }}</td>
                                        <td class="action-cell">
                                            {% if not item.sales_owner_name %}
                                            <button class="btn btn-sm btn-outline-primary" onclick="claimSalesOwnerTop({{ item.id }})">挙手</button>
                                            {% elif item.sales_owner_name == current_user_display_name %}
                                            <button class="btn btn-sm btn-outline-success" onclick="openTopStatusModal({{ item.id }}, '{{ item.follow_status|urlencode }}', '{{ item.sales_note|urlencode }}')">更新</button>
                                            {% else %}
                                            <span class="text-muted small">担当確定済</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="13" class="text-center text-muted py-4">最新データがありません</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="topStatusUpdateModal" tabindex="-1" aria-labelledby="topStatusUpdateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topStatusUpdateModalLabel">対応ステータス更新</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="topModalAssessmentId">
                    <div class="mb-3">
                        <label for="topModalFollowStatus" class="form-label">対応ステータス</label>
                        <select id="topModalFollowStatus" class="form-select">
                            {% for status in follow_status_choices %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="topModalSalesNote" class="form-label">コメント</label>
                        <textarea id="topModalSalesNote" class="form-control" rows="6" placeholder="電話結果・商談予定などを記録"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="saveTopStatusUpdate()">更新する</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="topDetailModal" tabindex="-1" aria-labelledby="topDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topDetailModalLabel">申込詳細</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
                </div>
                <div class="modal-body" id="topDetailBody">読み込み中...</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
    <script>
        const topStatusUpdateModal = new bootstrap.Modal(document.getElementById('topStatusUpdateModal'));
        const topDetailModal = new bootstrap.Modal(document.getElementById('topDetailModal'));

        function escapeHtml(value) {
            const div = document.createElement('div');
            div.textContent = value ?? '';
            return div.innerHTML;
        }

        function formatOwnerName(value) {
            const raw = (value || '').trim();
            if (!raw || raw === '-') return '-';
            return raw
                .split(/\s+/)
                .filter(Boolean)
                .map(part => escapeHtml(part))
                .join('<br>');
        }

        function applyTopOwnerLineBreaks() {
            document.querySelectorAll('.owner-name-cell').forEach((cell) => {
                cell.innerHTML = formatOwnerName(cell.textContent || '');
            });
        }

        applyTopOwnerLineBreaks();

        function getCsrfToken() {
            const cookie = document.cookie.split(';').map(v => v.trim()).find(v => v.startsWith('csrftoken='));
            return cookie ? cookie.split('=')[1] : '';
        }

        function claimSalesOwnerTop(assessmentId) {
            fetch(`/sateiinfo/api/assessments/${assessmentId}/claim/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
                credentials: 'same-origin',
            })
                .then(async (response) => {
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || '担当営業登録に失敗しました');
                    }
                    window.location.reload();
                })
                .catch((error) => {
                    alert(error.message);
                });
        }

        function openTopStatusModal(assessmentId, encodedStatus, encodedNote) {
            document.getElementById('topModalAssessmentId').value = assessmentId;
            document.getElementById('topModalFollowStatus').value = decodeURIComponent(encodedStatus || '未対応');
            document.getElementById('topModalSalesNote').value = decodeURIComponent(encodedNote || '');
            topStatusUpdateModal.show();
        }

        function saveTopStatusUpdate() {
            const assessmentId = document.getElementById('topModalAssessmentId').value;
            const followStatus = document.getElementById('topModalFollowStatus').value;
            const salesNote = document.getElementById('topModalSalesNote').value;

            fetch(`/sateiinfo/api/assessments/${assessmentId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    follow_status: followStatus,
                    sales_note: salesNote,
                }),
            })
                .then(async (response) => {
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || '更新に失敗しました');
                    }
                    topStatusUpdateModal.hide();
                    window.location.reload();
                })
                .catch((error) => {
                    alert(error.message);
                });
        }

        function openTopDetailModal(assessmentId) {
            const body = document.getElementById('topDetailBody');
            body.innerHTML = '読み込み中...';
            topDetailModal.show();

            fetch(`/sateiinfo/api/assessments/${assessmentId}/detail/`)
                .then(response => response.json())
                .then(result => {
                    if (!result.success) {
                        throw new Error(result.message || '詳細取得に失敗しました');
                    }

                    const d = result.data;
                    body.innerHTML = `
                        <div class="row g-3">
                            <div class="col-md-6"><strong>お申込番号</strong><div>${escapeHtml(d.application_number)}</div></div>
                            <div class="col-md-6"><strong>お申込日時</strong><div>${escapeHtml(d.application_datetime || '-')}</div></div>
                            <div class="col-md-6"><strong>担当営業</strong><div>${escapeHtml(d.sales_owner_name || '-')}</div></div>
                            <div class="col-md-6"><strong>対応ステータス</strong><div>${escapeHtml(d.follow_status || '-')}</div></div>
                            <div class="col-md-6"><strong>お名前</strong><div>${escapeHtml(d.customer_name || '-')}</div></div>
                            <div class="col-md-6"><strong>電話番号</strong><div>${escapeHtml(d.phone_number || '-')}</div></div>
                            <div class="col-md-6"><strong>希望売却時期</strong><div>${escapeHtml(d.desired_sale_timing || '-')}</div></div>
                            <div class="col-md-6"><strong>メーカー / 車種</strong><div>${escapeHtml(d.maker || '-')} / ${escapeHtml(d.car_model || '-')}</div></div>
                            <div class="col-md-6"><strong>年式 / 走行距離</strong><div>${escapeHtml(d.year || '-')} / ${escapeHtml(d.mileage || '-')}</div></div>
                            <div class="col-md-6"><strong>住所</strong><div>${escapeHtml(d.address || '-')}</div></div>
                            <div class="col-md-6"><strong>メールアドレス</strong><div>${escapeHtml(d.email || '-')}</div></div>
                            <div class="col-md-6"><strong>担当確定日時</strong><div>${escapeHtml(d.sales_assigned_at || '-')}</div></div>
                            <div class="col-12"><strong>コメント</strong><div class="border rounded p-2 bg-light">${escapeHtml(d.sales_note || '-')}</div></div>
                            <div class="col-md-6"><strong>更新者</strong><div>${escapeHtml(d.status_updated_by || '-')}</div></div>
                            <div class="col-md-6"><strong>更新日時</strong><div>${escapeHtml(d.status_updated_at || '-')}</div></div>
                        </div>
                    `;
                })
                .catch(error => {
                    body.innerHTML = `<div class="text-danger">${escapeHtml(error.message)}</div>`;
                });
        }

        function renderCalendarPanel(payload) {
            const panel = document.getElementById('calendarPanel');
            if (!panel) return;

            if (!payload.success) {
                panel.innerHTML = `<div class="workspace-empty">${escapeHtml(payload.message || 'カレンダー取得に失敗しました')}</div>`;
                return;
            }

            const items = Array.isArray(payload.items) ? payload.items : [];
            if (items.length === 0) {
                panel.innerHTML = '<div class="workspace-empty">直近の予定はありません</div>';
                return;
            }

            panel.innerHTML = items.map((item) => {
                return `
                    <div class="workspace-item calendar-item">
                        <div class="fw-semibold">${escapeHtml(item.summary || '(タイトル未設定)')}</div>
                        <div class="meta">${escapeHtml(item.start || '-')} / ${escapeHtml(item.location || '-')}</div>
                        <a href="${escapeHtml(item.link || 'https://calendar.google.com/')}" target="_blank" rel="noopener noreferrer" class="small text-success-emphasis text-decoration-none">予定を開く</a>
                    </div>
                `;
            }).join('');
        }

        function renderChatPanel(payload) {
            const panel = document.getElementById('chatPanel');
            if (!panel) return;

            if (!payload.success) {
                panel.innerHTML = `<div class="workspace-empty">${escapeHtml(payload.message || 'チャット取得に失敗しました')}</div>`;
                return;
            }

            const items = Array.isArray(payload.items) ? payload.items : [];
            if (items.length === 0) {
                panel.innerHTML = '<div class="workspace-empty">表示できるチャットメッセージはありません</div>';
                return;
            }

            panel.innerHTML = items.map((item) => {
                return `
                    <div class="workspace-item chat-item">
                        <div class="fw-semibold">${escapeHtml(item.space || 'スペース')}</div>
                        <div class="workspace-text">${escapeHtml(item.text || '(本文なし)')}</div>
                        <div class="meta">${escapeHtml(item.time || '-')} / ${escapeHtml(item.sender || '-')}</div>
                    </div>
                `;
            }).join('');
        }

        function loadGoogleWorkspacePanels() {
            fetch('/api/calendar-events/')
                .then(response => response.json())
                .then(renderCalendarPanel)
                .catch(() => renderCalendarPanel({ success: false, message: 'カレンダー取得に失敗しました。' }));

            fetch('/api/chat-messages/')
                .then(response => response.json())
                .then(renderChatPanel)
                .catch(() => renderChatPanel({ success: false, message: 'チャット取得に失敗しました。' }));
        }

        loadGoogleWorkspacePanels();
    </script>
{% endblock %}
