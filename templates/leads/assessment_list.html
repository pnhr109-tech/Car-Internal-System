{% extends 'base/internal_base.html' %}

{% block title %}車査定申込一覧 - gigicompany{% endblock %}

{% block extra_head %}
    <style>
        .navbar-header {
            background-color: #343a40;
            border-bottom: 2px solid #dee2e6;
        }
        
        .company-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .company-logo-icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }
        
        .search-card {
            margin-bottom: 20px;
        }
        
        .badge-new {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .info-badge {
            background-color: #0d6efd;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .summary-line {
            font-size: 1.1rem;
        }

        .summary-line .info-badge {
            font-size: 1.05rem;
            padding: 7px 12px;
        }
        
        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6c757d;
        }

        .assessment-table th,
        .assessment-table td {
            font-size: 0.84rem;
            padding: 0.4rem 0.45rem;
            line-height: 1.25;
            vertical-align: middle;
        }

        .assessment-table .badge {
            font-size: 0.72rem;
        }

        .assessment-table .btn-sm {
            --bs-btn-padding-y: 0.18rem;
            --bs-btn-padding-x: 0.42rem;
            --bs-btn-font-size: 0.72rem;
        }

        .assessment-table .application-number-cell {
            padding-left: 0.45rem;
            padding-right: 0.95rem;
            white-space: nowrap;
            text-align: left;
        }

        .assessment-table .application-number-col {
            min-width: 120px;
            white-space: nowrap;
        }

        .assessment-table .owner-name-cell {
            white-space: normal;
            line-height: 1.15;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- ローディングオーバーレイ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- トースト通知エリア -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container-fluid py-4">
        <!-- ヘッダーエリア -->
        <div class="row mb-3">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-1">
                        <i class="bi bi-car-front-fill text-primary"></i>
                        査定申込データ
                    </h4>
                    <button class="btn btn-primary" onclick="resetAndLoad()">
                        <i class="bi bi-arrow-clockwise"></i> 再読込
                    </button>
                </div>
            </div>
        </div>

        <!-- 検索フォーム -->
        <div class="card search-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-search"></i> 検索
                </h5>
            </div>
            <div class="card-body">
                <form id="searchForm" onsubmit="event.preventDefault(); searchAssessments();">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="applicationNumber" class="form-label">お申込番号</label>
                            <input type="text" class="form-control" id="applicationNumber" placeholder="例: 9060727">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">お申込日時（範囲検索）</label>
                            <div class="row g-2">
                                <div class="col-5">
                                    <input type="date" class="form-control" id="dateFrom">
                                </div>
                                <div class="col-2 date-separator">
                                    ～
                                </div>
                                <div class="col-5">
                                    <input type="date" class="form-control" id="dateTo">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="address" class="form-label">住所</label>
                            <input type="text" class="form-control" id="address" placeholder="例: 東京都">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> 検索
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="clearSearch()">
                                <i class="bi bi-x-circle"></i> クリア
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 件数表示エリア（検索フォームの下） -->
        <div class="row mb-3">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <p class="text-muted mb-0 summary-line">
                        <span class="info-badge" id="totalCountBadge">総件数: <span id="totalCount">-</span>件</span>
                        <span class="ms-2" id="currentPageInfo">
                            (<span id="pageStart">-</span>～<span id="pageEnd">-</span>件目を表示)
                        </span>
                    </p>
                    <div id="paginationTopRow" style="display: none;">
                        <nav aria-label="ページネーション" id="paginationNavTop">
                            <ul class="pagination mb-0" id="paginationContainerTop">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- データテーブル -->
        <div class="card">
            <div class="card-body p-0 table-container">
                <table class="table table-hover table-striped mb-0 assessment-table">
                    <thead class="table-dark sticky-top">
                        <tr>
                            <th class="application-number-col">お申込番号</th>
                            <th>お申込日時</th>
                            <th>担当営業</th>
                            <th>対応ステータス</th>
                            <th>お名前</th>
                            <th>電話番号</th>
                            <th>希望売却時期</th>
                            <th>メーカー</th>
                            <th>車種</th>
                            <th>年式</th>
                            <th>走行距離</th>
                            <th>住所</th>
                            <th>メールアドレス</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="assessmentTableBody">
                        <tr>
                            <td colspan="14" class="text-center text-muted">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                データを読み込んでいます...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ページネーション（下部） -->
        <div class="row mt-3" id="paginationBottomRow" style="display: none;">
            <div class="col">
                <div class="d-flex justify-content-end align-items-center">
                    <nav aria-label="ページネーション" id="paginationNavBottom">
                        <ul class="pagination mb-0" id="paginationContainerBottom">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-labelledby="statusUpdateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statusUpdateModalLabel">対応ステータス更新</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalAssessmentId">
                    <div class="mb-3">
                        <label for="modalFollowStatus" class="form-label">対応ステータス</label>
                        <select id="modalFollowStatus" class="form-select">
                            {% for status in follow_status_choices %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="modalSalesNote" class="form-label">コメント</label>
                        <textarea id="modalSalesNote" class="form-control" rows="6" placeholder="電話結果・商談予定などを記録"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    <button type="button" class="btn btn-primary" onclick="saveStatusUpdate()">更新する</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assessmentDetailModal" tabindex="-1" aria-labelledby="assessmentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assessmentDetailModalLabel">申込詳細</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
                </div>
                <div class="modal-body" id="assessmentDetailBody">
                    読み込み中...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
    <script>
        let currentPage = 1;
        let perPage = 100;
        let totalPages = 1;
        let currentFilters = {};
        const currentUserDisplayName = '{{ current_user_display_name|escapejs }}';
        const statusUpdateModal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
        const assessmentDetailModal = new bootstrap.Modal(document.getElementById('assessmentDetailModal'));

        function escapeHtml(value) {
            const div = document.createElement('div');
            div.textContent = value ?? '';
            return div.innerHTML;
        }

        function formatOwnerName(value) {
            const raw = (value || '').trim();
            if (!raw || raw === '-') return '-';
            return raw
                .split(/\s+/)
                .filter(Boolean)
                .map(part => escapeHtml(part))
                .join('<br>');
        }

        // ページ読み込み時に初期データ取得
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessments();
        });

        // データ読み込み
        function loadAssessments(page = 1) {
            showLoading();
            currentPage = page;
            
            const params = new URLSearchParams({
                page: currentPage,
                per_page: perPage
            });
            
            fetch(`/sateiinfo/api/assessments/?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTable(data.data);
                        updatePagination(data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('エラー', 'データの読み込みに失敗しました', 'danger');
                })
                .finally(() => {
                    hideLoading();
                });
        }

        // 検索実行
        function searchAssessments(page = 1) {
            showLoading();
            currentPage = page;
            
            // 検索条件を保存
            currentFilters = {
                application_number: document.getElementById('applicationNumber').value,
                date_from: document.getElementById('dateFrom').value,
                date_to: document.getElementById('dateTo').value,
                address: document.getElementById('address').value
            };
            
            const params = new URLSearchParams({
                ...currentFilters,
                page: currentPage,
                per_page: perPage
            });

            fetch(`/sateiinfo/api/assessments/?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTable(data.data);
                        updatePagination(data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('エラー', '検索に失敗しました', 'danger');
                })
                .finally(() => {
                    hideLoading();
                });
        }

        // ページネーション情報更新
        function updatePagination(data) {
            // 総件数表示
            document.getElementById('totalCount').textContent = data.total_count.toLocaleString();
            
            // 現在ページの件数表示
            const start = data.total_count > 0 ? (data.page - 1) * data.per_page + 1 : 0;
            const end = Math.min(data.page * data.per_page, data.total_count);
            document.getElementById('pageStart').textContent = start.toLocaleString();
            document.getElementById('pageEnd').textContent = end.toLocaleString();
            
            totalPages = data.total_pages;
            
            // ページネーションUIを構築
            renderPagination(data);
        }

        // ページネーションUI構築
        function renderPagination(data) {
            const containerTop = document.getElementById('paginationContainerTop');
            const containerBottom = document.getElementById('paginationContainerBottom');
            const rowTop = document.getElementById('paginationTopRow');
            const rowBottom = document.getElementById('paginationBottomRow');
            
            if (data.total_pages <= 1) {
                rowTop.style.display = 'none';
                rowBottom.style.display = 'none';
                return;
            }
            
            rowTop.style.display = 'block';
            rowBottom.style.display = 'block';
            let html = '';
            
            // 前へボタン
            html += `
                <li class="page-item ${!data.has_previous ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); ${data.has_previous ? 'goToPage(' + (data.page - 1) + ')' : 'return false;'}">
                        <i class="bi bi-chevron-left"></i> 前へ
                    </a>
                </li>
            `;
            
            // ページ番号ボタン
            const maxButtons = 5;
            let startPage = Math.max(1, data.page - Math.floor(maxButtons / 2));
            let endPage = Math.min(data.total_pages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage(1)">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === data.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); goToPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < data.total_pages) {
                if (endPage < data.total_pages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage(${data.total_pages})">${data.total_pages}</a></li>`;
            }
            
            // 次へボタン
            html += `
                <li class="page-item ${!data.has_next ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); ${data.has_next ? 'goToPage(' + (data.page + 1) + ')' : 'return false;'}">
                        次へ <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            containerTop.innerHTML = html;
            containerBottom.innerHTML = html;
        }
        
        // 初期状態にリセットして再読込
        function resetAndLoad() {
            clearSearch();
            currentPage = 1;
            loadAssessments(1);
        }

        // ページ移動
        function goToPage(page) {
            // 検索条件がある場合は検索、ない場合は通常読み込み
            if (Object.values(currentFilters).some(v => v)) {
                searchAssessments(page);
            } else {
                loadAssessments(page);
            }
            
            // ページトップにスクロール
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 検索クリア
        function clearSearch() {
            document.getElementById('searchForm').reset();
            currentFilters = {};
        }

        // テーブル描画
        function renderTable(data) {
            const tbody = document.getElementById('assessmentTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">データがありません</td></tr>';
                return;
            }

            const statusBadge = (status) => {
                const clsMap = {
                    '未対応': 'secondary',
                    '不通': 'dark',
                    '再コール予定': 'warning text-dark',
                    '商談アポ獲得': 'primary',
                    '成約': 'success',
                    '見送り': 'danger',
                };
                return `<span class="badge bg-${clsMap[status] || 'secondary'}">${escapeHtml(status || '未対応')}</span>`;
            };

            const renderAction = (item) => {
                if (!item.sales_owner_name) {
                    return `<button class="btn btn-sm btn-outline-primary" onclick="claimSalesOwner(${item.id})">挙手</button>`;
                }

                if (item.sales_owner_name === currentUserDisplayName) {
                    const encodedStatus = encodeURIComponent(item.follow_status || '未対応');
                    const encodedNote = encodeURIComponent(item.sales_note || '');
                    return `<button class="btn btn-sm btn-outline-success" onclick="openStatusModal(${item.id}, '${encodedStatus}', '${encodedNote}')">更新</button>`;
                }

                return '<span class="text-muted small">担当確定済</span>';
            };

            const renderPhoneLink = (phoneNumber) => {
                const raw = phoneNumber || '';
                const tel = raw.replace(/[^0-9+]/g, '');
                if (!tel) return '-';
                return `<a href="tel:${tel}" class="text-decoration-none">${escapeHtml(raw)}</a>`;
            };

            tbody.innerHTML = data.map(item => `
                <tr>
                    <td class="application-number-cell"><a href="#" class="text-decoration-none fw-semibold" onclick="event.preventDefault(); openAssessmentDetailModal(${item.id})">${escapeHtml(item.application_number)}</a></td>
                    <td>${item.application_datetime}</td>
                    <td class="owner-name-cell">${formatOwnerName(item.sales_owner_name)}</td>
                    <td>${statusBadge(item.follow_status)}</td>
                    <td>${item.customer_name}</td>
                    <td>${renderPhoneLink(item.phone_number)}</td>
                    <td>${item.desired_sale_timing}</td>
                    <td>${item.maker}</td>
                    <td>${item.car_model}</td>
                    <td>${item.year}</td>
                    <td>${item.mileage}</td>
                    <td>${item.address}</td>
                    <td>${item.email}</td>
                    <td>${renderAction(item)}</td>
                </tr>
            `).join('');
        }

        function getCsrfToken() {
            const cookie = document.cookie.split(';').map(v => v.trim()).find(v => v.startsWith('csrftoken='));
            return cookie ? cookie.split('=')[1] : '';
        }

        function refreshCurrentList() {
            if (Object.values(currentFilters).some(v => v)) {
                searchAssessments(currentPage);
            } else {
                loadAssessments(currentPage);
            }
        }

        function claimSalesOwner(assessmentId) {
            fetch(`/sateiinfo/api/assessments/${assessmentId}/claim/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
                credentials: 'same-origin',
            })
                .then(async (response) => {
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || '担当営業登録に失敗しました');
                    }
                    showToast('成功', data.message || '担当営業を登録しました', 'success');
                    refreshCurrentList();
                })
                .catch((error) => {
                    showToast('エラー', error.message, 'danger');
                });
        }

        function openAssessmentDetailModal(assessmentId) {
            const body = document.getElementById('assessmentDetailBody');
            body.innerHTML = '読み込み中...';
            assessmentDetailModal.show();

            fetch(`/sateiinfo/api/assessments/${assessmentId}/detail/`)
                .then(response => response.json())
                .then(result => {
                    if (!result.success) {
                        throw new Error(result.message || '詳細取得に失敗しました');
                    }

                    const d = result.data;
                    body.innerHTML = `
                        <div class="row g-3">
                            <div class="col-md-6"><strong>お申込番号</strong><div>${escapeHtml(d.application_number)}</div></div>
                            <div class="col-md-6"><strong>お申込日時</strong><div>${escapeHtml(d.application_datetime || '-')}</div></div>
                            <div class="col-md-6"><strong>担当営業</strong><div>${escapeHtml(d.sales_owner_name || '-')}</div></div>
                            <div class="col-md-6"><strong>対応ステータス</strong><div>${escapeHtml(d.follow_status || '-')}</div></div>
                            <div class="col-md-6"><strong>お名前</strong><div>${escapeHtml(d.customer_name || '-')}</div></div>
                            <div class="col-md-6"><strong>電話番号</strong><div>${escapeHtml(d.phone_number || '-')}</div></div>
                            <div class="col-md-6"><strong>希望売却時期</strong><div>${escapeHtml(d.desired_sale_timing || '-')}</div></div>
                            <div class="col-md-6"><strong>メーカー / 車種</strong><div>${escapeHtml(d.maker || '-')} / ${escapeHtml(d.car_model || '-')}</div></div>
                            <div class="col-md-6"><strong>年式 / 走行距離</strong><div>${escapeHtml(d.year || '-')} / ${escapeHtml(d.mileage || '-')}</div></div>
                            <div class="col-md-6"><strong>住所</strong><div>${escapeHtml(d.address || '-')}</div></div>
                            <div class="col-md-6"><strong>メールアドレス</strong><div>${escapeHtml(d.email || '-')}</div></div>
                            <div class="col-md-6"><strong>担当確定日時</strong><div>${escapeHtml(d.sales_assigned_at || '-')}</div></div>
                            <div class="col-12"><strong>コメント</strong><div class="border rounded p-2 bg-light">${escapeHtml(d.sales_note || '-')}</div></div>
                            <div class="col-md-6"><strong>更新者</strong><div>${escapeHtml(d.status_updated_by || '-')}</div></div>
                            <div class="col-md-6"><strong>更新日時</strong><div>${escapeHtml(d.status_updated_at || '-')}</div></div>
                        </div>
                    `;
                })
                .catch(error => {
                    body.innerHTML = `<div class="text-danger">${escapeHtml(error.message)}</div>`;
                });
        }

        function openStatusModal(assessmentId, encodedStatus, encodedNote) {
            document.getElementById('modalAssessmentId').value = assessmentId;
            const currentStatus = decodeURIComponent(encodedStatus || '未対応');
            const currentNote = decodeURIComponent(encodedNote || '');
            document.getElementById('modalFollowStatus').value = currentStatus;
            document.getElementById('modalSalesNote').value = currentNote;
            statusUpdateModal.show();
        }

        function saveStatusUpdate() {
            const assessmentId = document.getElementById('modalAssessmentId').value;
            const followStatus = document.getElementById('modalFollowStatus').value;
            const salesNote = document.getElementById('modalSalesNote').value;

            fetch(`/sateiinfo/api/assessments/${assessmentId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    follow_status: followStatus,
                    sales_note: salesNote,
                }),
            })
                .then(async (response) => {
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.message || '更新に失敗しました');
                    }
                    statusUpdateModal.hide();
                    showToast('成功', data.message || '更新しました', 'success');
                    refreshCurrentList();
                })
                .catch((error) => {
                    showToast('エラー', error.message, 'danger');
                });
        }

        // トースト通知表示
        function showToast(title, message, type = 'info', autohide = true, onClick = null) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'danger': 'bg-danger',
                'info': 'bg-info',
                'warning': 'bg-warning'
            }[type] || 'bg-info';

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" ${autohide ? 'data-bs-autohide="true" data-bs-delay="5000"' : 'data-bs-autohide="false"'}>
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            
            if (onClick) {
                toastElement.addEventListener('click', onClick);
                toastElement.style.cursor = 'pointer';
            }
            
            toast.show();
        }

        // ローディング表示
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        // ローディング非表示
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    </script>
{% endblock %}
