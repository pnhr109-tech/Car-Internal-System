# Gmail Pushé€šçŸ¥ï¼ˆPub/Subï¼‰è¨­å®šæ‰‹é †

Gmail APIã®Pushé€šçŸ¥ã‚’ä½¿ç”¨ã—ã¦ã€æ–°ç€ãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•çš„ã«æ¤œçŸ¥ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã™ã€‚

## ğŸ“‹ æ¦‚è¦

å¾“æ¥ã®å®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ã§ã¯ãªãã€Gmail Pushé€šçŸ¥ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã—ã¾ã™ã€‚

**ä»•çµ„ã¿:**
```
æ–°ç€ãƒ¡ãƒ¼ãƒ« â†’ Gmail â†’ Pub/Sub â†’ Webhook â†’ Django â†’ ãƒ¡ãƒ¼ãƒ«å–å¾—ãƒ»DBä¿å­˜
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œçŸ¥ï¼ˆæ•°ç§’ä»¥å†…ï¼‰
- ğŸ’° APIã‚³ãƒ¼ãƒ«å‰Šæ¸›ï¼ˆå®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦ï¼‰
- ğŸ“‰ ã‚³ã‚¹ãƒˆå‰Šæ¸›

---

## ğŸ”§ äº‹å‰æº–å‚™

### 1. Google Cloud Consoleã§ã®è¨­å®š

#### Step 1: Pub/Subãƒˆãƒ”ãƒƒã‚¯ä½œæˆ

1. [Google Cloud Console](https://console.cloud.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠï¼ˆGmail APIæœ‰åŠ¹åŒ–æ¸ˆã¿ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ **Pub/Sub** â†’ **ãƒˆãƒ”ãƒƒã‚¯** ã‚’é¸æŠ
4. **ãƒˆãƒ”ãƒƒã‚¯ã‚’ä½œæˆ** ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ä»¥ä¸‹ã‚’å…¥åŠ›ï¼š
   - **ãƒˆãƒ”ãƒƒã‚¯ID**: `gmail-push`ï¼ˆä»»æ„ã®åå‰ï¼‰
   - ãã®ä»–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾
6. **ä½œæˆ** ã‚’ã‚¯ãƒªãƒƒã‚¯
7. ä½œæˆã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯åã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾‹: `projects/your-project-id/topics/gmail-push`ï¼‰

**ã‚ãªãŸã®ãƒˆãƒ”ãƒƒã‚¯å:**
```
projects/navikuru-mail-system/topics/gmail-push
```

#### Step 2: Pub/Subãƒˆãƒ”ãƒƒã‚¯ã«æ¨©é™ã‚’è¿½åŠ 

Gmail APIãŒPub/Subãƒˆãƒ”ãƒƒã‚¯ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«æ¨©é™ã‚’è¨­å®šã—ã¾ã™ã€‚

1. ä½œæˆã—ãŸãƒˆãƒ”ãƒƒã‚¯ `gmail-push` ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä¸Šéƒ¨ã®ã‚¿ãƒ–ã‹ã‚‰ **æ¨©é™** ã‚’é¸æŠ
3. **ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã‚’è¿½åŠ ** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä»¥ä¸‹ã‚’å…¥åŠ›ï¼š
   - **æ–°ã—ã„ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«**: `gmail-api-push@system.gserviceaccount.com`
   - **ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠ**: `Pub/Sub ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼` ã‚’æ¤œç´¢ã—ã¦é¸æŠ
5. **ä¿å­˜** ã‚’ã‚¯ãƒªãƒƒã‚¯

âš ï¸ **é‡è¦**: ã“ã®æ¨©é™è¨­å®šãŒãªã„ã¨ã€`gmail_watch_start`ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«403ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

---

### 2. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆngrokä½¿ç”¨ï¼‰

#### Step 1: ngrokã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**â‘  ngrokã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**

1. [ngrokå…¬å¼ã‚µã‚¤ãƒˆ](https://ngrok.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹
2. **Sign up for free** ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ï¼ˆç„¡æ–™ï¼‰
3. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ **Windows (64-bit)** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ `ngrok.zip` ã‚’è§£å‡
5. è§£å‡ã—ãŸ `ngrok.exe` ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼
   ```
   C:\Users\pnhr1\OneDrive\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\01_gigi_work\01_ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ \01_ã‚¢ãƒ—ãƒªé–‹ç™º\01_ãƒŠãƒ“ã‚¯ãƒ«æ–°ç€ãƒ¡ãƒ¼ãƒ«èª­è¾¼\
   ```

**â‘¡ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š**

ngrokãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã‚ãªãŸã®ãƒˆãƒ¼ã‚¯ãƒ³: `39b5lWXCXzMS2qXqol4HXnTyyEc_7fGDeT1fS4gCPeTNGyZ1j`ï¼‰

PowerShellã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

```powershell
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
cd "C:\Users\pnhr1\OneDrive\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\01_gigi_work\01_ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ \01_ã‚¢ãƒ—ãƒªé–‹ç™º\01_ãƒŠãƒ“ã‚¯ãƒ«æ–°ç€ãƒ¡ãƒ¼ãƒ«èª­è¾¼"

# èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
.\ngrok.exe config add-authtoken 39b5lWXCXzMS2qXqol4HXnTyyEc_7fGDeT1fS4gCPeTNGyZ1j
```

æˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```
Authtoken saved to configuration file: C:\Users\pnhr1\.ngrok2\ngrok.yml
```

**â‘¢ ngrokã®å‹•ä½œç¢ºèª**

```powershell
# ngrokã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
.\ngrok.exe version
```

#### Step 2: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```powershell
# ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
.\venv\Scripts\Activate.ps1

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt
```

#### Step 3: Djangoã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•

**ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1ï¼ˆDjangoã‚µãƒ¼ãƒãƒ¼ç”¨ï¼‰**

```powershell
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
cd "C:\Users\pnhr1\OneDrive\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\01_gigi_work\01_ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ \01_ã‚¢ãƒ—ãƒªé–‹ç™º\01_ãƒŠãƒ“ã‚¯ãƒ«æ–°ç€ãƒ¡ãƒ¼ãƒ«èª­è¾¼"

# ä»®æƒ³ç’°å¢ƒã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
.\venv\Scripts\Activate.ps1

# MySQLã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ï¼ˆã¾ã ã®å ´åˆï¼‰
docker-compose up -d

# Djangoã‚µãƒ¼ãƒãƒ¼èµ·å‹•
python manage.py runserver
```

ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

**ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2ï¼ˆngrokç”¨ï¼‰**

**æ–°ã—ã„PowerShellã‚¦ã‚£ãƒ³ãƒ‰ã‚¦**ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

```powershell
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
cd "C:\Users\pnhr1\OneDrive\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\01_gigi_work\01_ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ \01_ã‚¢ãƒ—ãƒªé–‹ç™º\01_ãƒŠãƒ“ã‚¯ãƒ«æ–°ç€ãƒ¡ãƒ¼ãƒ«èª­è¾¼"

# ngrokèµ·å‹•
.\ngrok.exe http 8000
```

ngrokãŒèµ·å‹•ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
ngrok                                                                                                                                           

Session Status                online
Account                       your-email@example.com
Version                       3.x.x
Region                        Japan (jp)
Latency                       -
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://xxxx-xxxx-xxxx.ngrok-free.app -> http://localhost:8000

Connections                   ttl     opn     rt1     rt5     p50     p90
                              0       0       0.00    0.00    0.00    0.00
```

**ã‚ãªãŸã®ngrok URL:**
```
https://lavinia-ornamented-jadiel.ngrok-free.dev
```

#### Step 4: Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆï¼ˆWebhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç™»éŒ²ï¼‰

**è©³ç´°ãªæ‰‹é †:**

1. [Google Cloud Console](https://console.cloud.google.com/) ã‚’é–‹ã
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ `navikuru-mail-system` ã‚’é¸æŠ
3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ **Pub/Sub** â†’ **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³** ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä¸Šéƒ¨ã® **ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ä»¥ä¸‹ã®é …ç›®ã‚’å…¥åŠ›ï¼š

   **â‘  ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ID**
   ```
   gmail-push-subscription
   ```
   
   **â‘¡ Cloud Pub/Sub ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠ**
   - ã€Œãƒˆãƒ”ãƒƒã‚¯ã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   - `gmail-push` ã‚’é¸æŠ
   
   **â‘¢ é…ä¿¡ã‚¿ã‚¤ãƒ—**
   - **ã€Œãƒ—ãƒƒã‚·ãƒ¥ã€** ã‚’é¸æŠï¼ˆé‡è¦ï¼ï¼‰
   - âš ï¸ ã“ã“ã§ã€Œãƒ—ãƒƒã‚·ãƒ¥ã€ã‚’é¸æŠã™ã‚‹ã¨ã€ä¸‹ã«æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
   
   **â‘£ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ URL**ï¼ˆã€Œãƒ—ãƒƒã‚·ãƒ¥ã€é¸æŠå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
   ```
   https://lavinia-ornamented-jadiel.ngrok-free.dev/sateiinfo/webhook/gmail-push/
   ```
   
   **â‘¤ ãã®ä»–ã®è¨­å®š**
   - ã€Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã€: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆæœŸé™ãªã—ï¼‰
   - ã€Œç¢ºèªå¿œç­”ã®æœŸé™ã€: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ10ç§’ï¼‰
   - ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿æŒæœŸé–“ã€: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ7æ—¥ï¼‰
   - ãã®ä»–ã¯ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾

6. ç”»é¢ä¸‹éƒ¨ã® **ä½œæˆ** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

**ç¢ºèª:**
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§ã« `gmail-push-subscription` ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- ã€Œé…ä¿¡ã‚¿ã‚¤ãƒ—: ãƒ—ãƒƒã‚·ãƒ¥ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹

âš ï¸ **é‡è¦**: 
- é…ä¿¡ã‚¿ã‚¤ãƒ—ã§ã€Œãƒ—ãƒƒã‚·ãƒ¥ã€ã‚’é¸æŠã—ãªã„ã¨ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã®å…¥åŠ›æ¬„ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“
- ngrokã‚’å†èµ·å‹•ã—ã¦URLãŒå¤‰ã‚ã£ãŸå ´åˆã¯ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç·¨é›†ã—ã¦URLã‚’æ›´æ–°ã—ã¦ãã ã•ã„

---

### 3. Gmail Watchã®é–‹å§‹

```powershell
# ä»®æƒ³ç’°å¢ƒå†…ã§å®Ÿè¡Œ
python manage.py gmail_watch_start --topic projects/navikuru-mail-system/topics/gmail-push
```

**å®Ÿè¡Œä¾‹:**
```
============================================================
Gmail Pushé€šçŸ¥ï¼ˆWatchï¼‰è¨­å®šé–‹å§‹
============================================================

è¨­å®šå†…å®¹:
  ãƒˆãƒ”ãƒƒã‚¯: projects/your-project-123/topics/gmail-push
  ãƒ©ãƒ™ãƒ«: INBOX

âœ… Watchè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼

è©³ç´°:
  å±¥æ­´ID: 12345678
  æœ‰åŠ¹æœŸé™: 2026-02-20 15:30:00

âš ï¸  7æ—¥å¾Œã«è‡ªå‹•çš„ã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚å®šæœŸçš„ã«å†è¨­å®šã—ã¦ãã ã•ã„ã€‚
============================================================
```

âš ï¸ **é‡è¦**: Watchã¯7æ—¥é–“ã§è‡ªå‹•çš„ã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚å®šæœŸçš„ã«å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

---

## ğŸ§ª å‹•ä½œãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆæ–¹æ³•1: æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆWebhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèªï¼‰

**ç›®çš„**: Pub/Subã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Œã‚‹ã‹ç¢ºèª

**å‰ææ¡ä»¶**:
- âœ… Djangoã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ (`python manage.py runserver`)
- âœ… ngrokãŒèµ·å‹•ã—ã¦ã„ã‚‹ (`.\ngrok.exe http 8000`)

**æ‰‹é †**:

1. **PowerShellã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ**:
   ```powershell
   $body = @{ message = @{ data = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes('{"emailAddress":"kaitori@gigicompany.jp","historyId":"123"}')) } } | ConvertTo-Json
   
   Invoke-WebRequest -Uri "https://lavinia-ornamented-jadiel.ngrok-free.dev/sateiinfo/webhook/gmail-push/" -Method POST -Body $body -ContentType "application/json"
   ```

2. **æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
   ```
   StatusCode        : 200
   StatusDescription : OK
   ```

3. **Djangoã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã™ã¹ããƒ­ã‚°**:
   ```
   Received request body: b'{"message":{"data":"eyJlbWFpbEFkZHJlc3MiOiJrYWl0b3JpQGdpZ2ljb21wYW55LmpwIiwiaGlzdG9yeUlkIjoiMTIzIn0="}}'
   Parsed envelope: {'message': {'data': '...'}}
   Received push notification: {'emailAddress': 'kaitori@gigicompany.jp', 'historyId': '123'}
   Email: kaitori@gigicompany.jp, HistoryID: 123
   
   ============================================================
   Gmail ãƒ¡ãƒ¼ãƒ«å–å¾—é–‹å§‹
   ============================================================
   âœ“ Gmail APIæ¥ç¶šæˆåŠŸ
   
   æ¤œç´¢æ¡ä»¶: subject:ç”³è¾¼ã¿ä¾é ¼ãŒã”ã–ã„ã¾ã—ãŸ from:info@a-satei.com to:kaitori@gigicompany.jp newer_than:1d
   æœ€å¤§å–å¾—ä»¶æ•°: 10
   å–å¾—: æœ€æ–°10ä»¶ï¼ˆæ–°ã—ã„é †ï¼‰
   
   Xä»¶ã®ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
   ...
   âœ… å®Œäº†
   [13/Feb/2026 13:XX:XX] "POST /sateiinfo/webhook/gmail-push/ HTTP/1.1" 200 0
   ```

4. **ngrokã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª**:
   ```
   POST /sateiinfo/webhook/gmail-push/ 200 OK
   ```

**âŒ ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ**:

- `400 Bad Request` â†’ ALLOWED_HOSTSã®è¨­å®šã‚’ç¢ºèª
- `Failed to fetch emails: No module named 'googleapiclient'` â†’ Djangoã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
- `500 Internal Server Error` â†’ Djangoã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª

---

### ãƒ†ã‚¹ãƒˆæ–¹æ³•2: å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ï¼‰

**ç›®çš„**: Gmailæ–°ç€ â†’ Pub/Sub â†’ ngrok â†’ Django â†’ DBä¿å­˜ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèª

**å‰ææ¡ä»¶**:
- âœ… Djangoã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹
- âœ… ngrokãŒèµ·å‹•ã—ã¦ã„ã‚‹
- âœ… Gmail Watchè¨­å®šæ¸ˆã¿ï¼ˆæœ‰åŠ¹æœŸé™å†…ï¼‰
- âœ… Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆæ¸ˆã¿

**æ‰‹é †**:

1. **äº‹å‰ç¢ºèª**: ç¾åœ¨ã®æœ€æ–°ç”³è¾¼ç•ªå·ã‚’ãƒ¡ãƒ¢
   - http://127.0.0.1:8000/sateiinfo/ ã‚’é–‹ã
   - ä¸€è¦§ã®ä¸€ç•ªä¸Šã®ç”³è¾¼ç•ªå·ã‚’ç¢ºèª

2. **ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡**:
   - é€ä¿¡å…ƒ: `info@a-satei.com`
   - é€ä¿¡å…ˆ: `kaitori@gigicompany.jp`
   - ä»¶å: `ã€ã‹ã‚“ãŸã‚“è»ŠæŸ»å®šã‚¬ã‚¤ãƒ‰ã€‘ç”³è¾¼ã¿ä¾é ¼ãŒã”ã–ã„ã¾ã—ãŸã€‚`
   - æœ¬æ–‡: é€šå¸¸ã®ç”³è¾¼ãƒ¡ãƒ¼ãƒ«å†…å®¹

3. **Djangoã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç›£è¦–**ï¼ˆæ•°ç§’ï½æ•°åç§’ä»¥å†…ã«è‡ªå‹•çš„ã«å‹•ä½œï¼‰:
   ```
   Received request body: b'...'
   Parsed envelope: {'message': {'data': '...'}}
   Received push notification: {'emailAddress': 'kaitori@gigicompany.jp', 'historyId': 'XXXXXXX'}
   Email: kaitori@gigicompany.jp, HistoryID: XXXXXXX
   
   ============================================================
   Gmail ãƒ¡ãƒ¼ãƒ«å–å¾—é–‹å§‹
   ============================================================
   âœ“ Gmail APIæ¥ç¶šæˆåŠŸ
   
   1ä»¶ã®ãƒ¡ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
     [1/1] âœ“ æ–°è¦ä¿å­˜ & ç”³è¾¼æƒ…å ±æŠ½å‡º ã€ã‹ã‚“ãŸã‚“è»ŠæŸ»å®šã‚¬ã‚¤ãƒ‰ã€‘ç”³è¾¼ã¿ä¾é ¼ãŒã”ã–ã„ã¾ã—ãŸã€‚ [PC]
   
   ============================================================
   âœ… å®Œäº†
     æ–°è¦ä¿å­˜: 1ä»¶
     ç”³è¾¼æƒ…å ±æŠ½å‡º: 1ä»¶
     ã‚¹ã‚­ãƒƒãƒ—: 0ä»¶
   ============================================================
   [13/Feb/2026 13:XX:XX] "POST /sateiinfo/webhook/gmail-push/ HTTP/1.1" 200 0
   ```

4. **WEBç”»é¢ã§ç¢ºèª**:
   - http://127.0.0.1:8000/sateiinfo/ ã‚’é–‹ãï¼ˆè‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ï¼‰
   - æ–°è¦ç”³è¾¼ãŒä¸€è¦§ã®ä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹
   - ç”»é¢ä¸Šéƒ¨ã®é€šçŸ¥ãƒ™ãƒ«ğŸ””ã«æ–°ç€é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹

5. **ngrokã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª**:
   ```
   HTTP Requests
   -------------
   13:XX:XX JST POST /sateiinfo/webhook/gmail-push/ 200 OK
   ```

**â±ï¸ ã‚¿ã‚¤ãƒŸãƒ³ã‚°**:
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‹ã‚‰é€šçŸ¥ã¾ã§: é€šå¸¸5ï½30ç§’
- Gmailå´ã®å‡¦ç†é…å»¶ã«ã‚ˆã‚Šã€æœ€å¤§1ï½2åˆ†ã‹ã‹ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™

**âŒ é€šçŸ¥ãŒæ¥ãªã„å ´åˆã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ**:

1. **Gmail Watchæœ‰åŠ¹æœŸé™ã‚’ç¢ºèª**:
   - 2026-02-20 12:55:15ã‚ˆã‚Šå‰ã‹ï¼Ÿ
   - æœŸé™åˆ‡ã‚Œã®å ´åˆ: `python manage.py gmail_watch_start --topic projects/navikuru-mail-system/topics/gmail-push`

2. **Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª**:
   - [Google Cloud Console](https://console.cloud.google.com/) â†’ Pub/Sub â†’ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
   - `gmail-push-subscription`ãŒå­˜åœ¨ã™ã‚‹ã‹
   - é…ä¿¡ã‚¿ã‚¤ãƒ—ãŒã€Œãƒ—ãƒƒã‚·ãƒ¥ã€ã«ãªã£ã¦ã„ã‚‹ã‹
   - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒæ­£ã—ã„ã‹ï¼ˆngrokã®URLï¼‰

3. **ngrokãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹**:
   - ngrokã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« `Forwarding https://... -> http://localhost:8000` ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹

4. **Djangoã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹**:
   - http://127.0.0.1:8000/sateiinfo/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹

5. **ngrok URLãŒå¤‰ã‚ã£ã¦ã„ãªã„ã‹**:
   - ngrokã‚’å†èµ·å‹•ã™ã‚‹ã¨URLãŒå¤‰ã‚ã‚Šã¾ã™
   - å¤‰ã‚ã£ãŸå ´åˆ: Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã‚’æ›´æ–°

---

### ãƒ†ã‚¹ãƒˆæ–¹æ³•3: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ç¢ºèª

**Djangoã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¦‹ã‚‹ã¹ããƒ­ã‚°**:

âœ… **æ­£å¸¸ãªå ´åˆ**:
```
Received request body: b'...'
Parsed envelope: {'message': {'data': '...'}}
Received push notification: {'emailAddress': 'kaitori@gigicompany.jp', 'historyId': '...'}
Email: kaitori@gigicompany.jp, HistoryID: ...
Email fetch triggered successfully
```

âŒ **ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆ**:
```
Failed to fetch emails: No module named 'googleapiclient'
â†’ è§£æ±ºç­–: Djangoã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•

JSON decode error: ...
â†’ è§£æ±ºç­–: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å½¢å¼ã‚’ç¢ºèª

Invalid HTTP_HOST header: '...'
â†’ è§£æ±ºç­–: config/settings.pyã®ALLOWED_HOSTSã‚’ç¢ºèª
```

---

### ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰

**æ‰‹å‹•ã§ãƒ¡ãƒ¼ãƒ«å–å¾—ï¼ˆPushé€šçŸ¥ã¨ã¯ç„¡é–¢ä¿‚ï¼‰**:
```powershell
# éå»1æ—¥åˆ†ã‚’æœ€å¤§10ä»¶å–å¾—
python manage.py fetch_gmail --days 1 --max 10

# éå»7æ—¥åˆ†ã‚’å…¨ã¦å–å¾—
python manage.py fetch_gmail --days 7
```

**Gmail WatchçŠ¶æ…‹ç¢ºèª**:
```powershell
# Watchè¨­å®šåœæ­¢ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
python manage.py gmail_watch_stop

# Watchè¨­å®šå†é–‹ï¼ˆ7æ—¥é–“æœ‰åŠ¹ï¼‰
python manage.py gmail_watch_start --topic projects/navikuru-mail-system/topics/gmail-push
```

**ngrok Web Interface**:
- http://127.0.0.1:4040 ã‚’é–‹ã
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™

---

## ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

### Cloud Run / GCE / App Engine ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

1. **ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤**
   - Cloud Runã€GCEã€App Engineãªã©ã«ãƒ‡ãƒ—ãƒ­ã‚¤
   - **å…¬é–‹URL**ã‚’å–å¾—ï¼ˆä¾‹: `https://your-app.run.app`ï¼‰

2. **Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°**
   - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL: `https://your-app.run.app/sateiinfo/webhook/gmail-push/`
   - ngrokã§ã¯ãªãæœ¬ç•ªURLã«å¤‰æ›´

3. **Gmail Watchã‚’å†è¨­å®š**
   ```bash
   python manage.py gmail_watch_start --topic projects/navikuru-mail-system/topics/gmail-push
   ```

4. **å®šæœŸçš„ãªWatchæ›´æ–°ï¼ˆcron / Cloud Schedulerï¼‰**
   - 7æ—¥ã”ã¨ã«Watchè¨­å®šã‚’æ›´æ–°ã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚’è¨­å®š
   ```bash
   # ä¾‹: Cloud Schedulerã§æ¯é€±å®Ÿè¡Œ
   0 0 * * 0 python manage.py gmail_watch_start --topic projects/navikuru-mail-system/topics/gmail-push
   ```

---

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Webhookã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãªã„

1. **Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª**
   - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒæ­£ã—ã„ã‹
   - ngrokãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
   - Djangoã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹

2. **Gmail WatchãŒæœ‰åŠ¹ã‹ç¢ºèª**
   ```powershell
   # Watchã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆç¾åœ¨ã¯ã‚³ãƒãƒ³ãƒ‰æœªå®Ÿè£…ï¼‰
   # 7æ—¥çµŒéã—ã¦ã„ãªã„ã‹ç¢ºèª
   ```

3. **æ¨©é™ã‚’ç¢ºèª**
   - Pub/Subãƒˆãƒ”ãƒƒã‚¯ã« `gmail-api-push@system.gserviceaccount.com` ã®æ¨©é™ãŒã‚ã‚‹ã‹

### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª

```powershell
# Djangoã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
# views.pyã®loggerã§å‡ºåŠ›ã•ã‚Œã¾ã™
```

### Watchè¨­å®šã‚’åœæ­¢

```powershell
python manage.py gmail_watch_stop
```

---

## ğŸ“Š ã‚³ã‚¹ãƒˆæ¯”è¼ƒ

### å¾“æ¥ã®å®šæœŸãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼
- 1åˆ†ã”ã¨ã«å®Ÿè¡Œ: **1,440å›/æ—¥**
- 1ãƒ¶æœˆ: **43,200å›**
- Gmail APIç„¡æ–™æ : **10å„„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆ**ï¼ˆååˆ†ï¼‰

### Pushé€šçŸ¥æ–¹å¼ï¼ˆæ¨å¥¨ï¼‰
- æ–°ç€ãƒ¡ãƒ¼ãƒ«ãŒã‚ã‚‹ã¨ãã ã‘å®Ÿè¡Œ
- ä¾‹: 100ä»¶/æ—¥ã®æ–°ç€ãƒ¡ãƒ¼ãƒ« = **100å›/æ—¥**
- 1ãƒ¶æœˆ: **3,000å›**
- **ç´„93%å‰Šæ¸›ï¼** ğŸ‰

---

## ğŸ“ æ—¥å¸¸é‹ç”¨

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚

1. MySQLã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
   ```powershell
   docker-compose up -d
   ```

2. ä»®æƒ³ç’°å¢ƒã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
   ```powershell
   .\venv\Scripts\Activate.ps1
   ```

3. Djangoã‚µãƒ¼ãƒãƒ¼èµ·å‹•
   ```powershell
   python manage.py runserver
   ```

4. ngrokèµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
   ```powershell
   ngrok http 8000
   ```

5. **åˆå›ã®ã¿**: Gmail Watchè¨­å®š
   ```powershell
   python manage.py gmail_watch_start --topic projects/navikuru-mail-system/topics/gmail-push
   ```

6. **ngrok URLãŒå¤‰ã‚ã£ãŸå ´åˆ**: Pub/Subã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°

### æœ¬ç•ªç’°å¢ƒ

- **7æ—¥ã”ã¨ã«Watchè¨­å®šã‚’æ›´æ–°**ï¼ˆCloud Schedulerã§è‡ªå‹•åŒ–æ¨å¥¨ï¼‰
- ãƒ­ã‚°ç›£è¦–

---

## ğŸ”„ å¾“æ¥ã®ãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ã¨ã®ä½µç”¨

Pushé€šçŸ¥ã¨ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ä½µç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š

- **Pushé€šçŸ¥**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œçŸ¥ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
- **ãƒãƒ¼ãƒªãƒ³ã‚°**: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ1æ™‚é–“ã”ã¨ãªã©ï¼‰

```powershell
# æ‰‹å‹•ã§ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
python manage.py fetch_gmail
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **Watchæœ‰åŠ¹æœŸé™**: 7æ—¥é–“ã§è‡ªå‹•çš„ã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™
2. **ngrokç„¡æ–™ç‰ˆ**: URLãŒæ¯å›å¤‰ã‚ã‚Šã¾ã™ï¼ˆæœ‰æ–™ç‰ˆã¯å›ºå®šURLï¼‰
3. **Pub/Subæ–™é‡‘**: ç„¡æ–™æ ã‚ã‚Šï¼ˆæœ€åˆã®10GBã¾ã§ç„¡æ–™ï¼‰
4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: æœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªèªè¨¼ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Gmail API - Push Notifications](https://developers.google.com/gmail/api/guides/push)
- [Google Cloud Pub/Sub](https://cloud.google.com/pubsub/docs)
- [ngrok Documentation](https://ngrok.com/docs)
